# Bandicoot CDR Visualization: Single-File Implementation Plan

## Executive Summary

This document presents a **radically simplified** approach to the Bandicoot Mapbox visualization that addresses all critical gaps identified in the code and architecture reviews while maintaining premium visual quality.

### The Core Insight

The original 42-file plan was over-engineered for a plugin that follows the "inline execution, no wrapper scripts" philosophy. This revision delivers the same stunning visualization as a **single self-contained HTML file** that:

1. Opens directly in any modern browser (no server required)
2. Contains all CSS, JavaScript, and data embedded inline
3. Is generated by a simple Python function from Bandicoot data
4. Maintains the glassmorphic, premium aesthetic
5. **Adds the missing Contact Filter and Date/Time Picker components**

### Key Changes from Original Plan

| Aspect | Original Plan | This Plan |
|--------|--------------|-----------|
| Files | 42+ files across directories | 1 HTML file |
| Build Process | ES6 modules, potential bundling | Zero build - direct browser open |
| Contact Filtering | **MISSING** | Full multi-select with search |
| Date/Time Picker | Basic `datetime-local` input | Calendar popup with presets |
| Integration | Unclear standalone app | Clear Python generation function |
| Maintenance | Complex multi-file updates | Single template to maintain |

---

## Architecture Overview

### Single File, Logical Modules

The HTML file is organized with clear comment blocks that delineate logical modules. This allows future extraction if needed while keeping the current implementation simple.

```
visualization.html
|
+-- <style> block
|   +-- CSS Reset & Variables
|   +-- Theme System (Dark/Light)
|   +-- Component Styles (organized by component)
|   +-- Animations & Keyframes
|
+-- <body> structure
|   +-- Map Container (full viewport)
|   +-- Control Panels (floating, glassmorphic)
|   |   +-- Top-Left: Theme Toggle, Contact Filter
|   |   +-- Top-Right: World Clock
|   |   +-- Bottom: Time Controls, Date Picker
|   +-- Popup Templates
|
+-- <script> block
    +-- MODULE: Configuration & Constants
    +-- MODULE: EventBus (pub/sub)
    +-- MODULE: StateManager
    +-- MODULE: ThemeController
    +-- MODULE: MapController
    +-- MODULE: TimeController
    +-- MODULE: ContactFilter (NEW)
    +-- MODULE: DateTimePicker (NEW)
    +-- MODULE: WorldClock
    +-- MODULE: TimeSlider
    +-- MODULE: PopupManager
    +-- MODULE: Application Bootstrap
    +-- DATA: Embedded GeoJSON (injected by Python)
```

---

## Design System: "Obsidian Lux"

### Design Philosophy

The aesthetic is **"Obsidian Lux"** - a fusion of Bloomberg Terminal's data density, Apple's refined minimalism, and cyberpunk's neon-accented darkness. This isn't generic glassmorphism - it's a specific, memorable visual identity.

### Typography

```css
/* Primary: Geist - Modern, technical, excellent readability */
/* Display: Geist Mono - For the world clock and data values */
/* These are distinctive choices that avoid the overused Inter/Space Grotesk */

@import url('https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono:wght@400;500;600&display=swap');

:root {
  --font-primary: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif;
  --font-mono: 'Geist Mono', 'SF Mono', monospace;
}
```

### Color Palette

```css
/* DARK THEME - "Obsidian" */
:root[data-theme="dark"] {
  /* Base - Deep blue-black, not pure black */
  --bg-void: #05070a;
  --bg-primary: #0a0e14;
  --bg-elevated: #111820;
  --bg-surface: #1a2332;

  /* Text - Warm whites, not clinical */
  --text-primary: #f0f4f8;
  --text-secondary: #8899a6;
  --text-muted: #4a5568;

  /* Accent - Electric cyan as primary, coral as secondary */
  --accent-primary: #00d4ff;
  --accent-secondary: #ff6b6b;
  --accent-tertiary: #7c3aed;
  --accent-glow: rgba(0, 212, 255, 0.4);

  /* Event Type Colors - Distinct, colorblind-friendly */
  --color-call-in: #10b981;    /* Emerald */
  --color-call-out: #3b82f6;   /* Blue */
  --color-text-in: #f59e0b;    /* Amber */
  --color-text-out: #ec4899;   /* Pink */

  /* Glass Properties */
  --glass-bg: rgba(10, 14, 20, 0.85);
  --glass-border: rgba(255, 255, 255, 0.06);
  --glass-highlight: rgba(255, 255, 255, 0.03);
  --glass-shadow: rgba(0, 0, 0, 0.5);
  --glass-blur: 20px;
}

/* LIGHT THEME - "Porcelain" */
:root[data-theme="light"] {
  /* Base - Warm off-whites */
  --bg-void: #f8fafc;
  --bg-primary: #ffffff;
  --bg-elevated: #ffffff;
  --bg-surface: #f1f5f9;

  /* Text - Rich blacks */
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;

  /* Accent - Deeper variants for contrast */
  --accent-primary: #0891b2;
  --accent-secondary: #e11d48;
  --accent-tertiary: #6d28d9;
  --accent-glow: rgba(8, 145, 178, 0.2);

  /* Glass Properties - Lighter blur */
  --glass-bg: rgba(255, 255, 255, 0.9);
  --glass-border: rgba(0, 0, 0, 0.06);
  --glass-highlight: rgba(255, 255, 255, 0.8);
  --glass-shadow: rgba(0, 0, 0, 0.08);
  --glass-blur: 16px;
}
```

### Glassmorphic Panel System

```css
.glass-panel {
  background: var(--glass-bg);
  backdrop-filter: blur(var(--glass-blur));
  -webkit-backdrop-filter: blur(var(--glass-blur));
  border: 1px solid var(--glass-border);
  border-radius: 16px;
  box-shadow:
    0 8px 32px var(--glass-shadow),
    inset 0 1px 0 var(--glass-highlight),
    inset 0 0 0 1px rgba(255, 255, 255, 0.02);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.glass-panel:hover {
  box-shadow:
    0 12px 40px var(--glass-shadow),
    inset 0 1px 0 var(--glass-highlight),
    0 0 0 1px var(--accent-primary);
  transform: translateY(-2px);
}

/* Accent glow effect for active states */
.glass-panel--active {
  box-shadow:
    0 0 30px var(--accent-glow),
    0 8px 32px var(--glass-shadow),
    inset 0 1px 0 var(--glass-highlight);
}
```

---

## Complete HTML Structure

```html
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bandicoot CDR Visualization - {{USER_ID}}</title>

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Geist:wght@400;500;600;700&family=Geist+Mono:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    /* ============================================================
       SECTION: CSS Reset & Base
       ============================================================ */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
      overflow: hidden;
      font-family: var(--font-primary);
      background: var(--bg-void);
      color: var(--text-primary);
    }

    /* ============================================================
       SECTION: CSS Variables & Theme System
       ============================================================ */
    :root {
      --font-primary: 'Geist', -apple-system, BlinkMacSystemFont, sans-serif;
      --font-mono: 'Geist Mono', 'SF Mono', monospace;

      /* Spacing Scale */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;
      --space-12: 48px;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
      --transition-slow: 400ms cubic-bezier(0.4, 0, 0.2, 1);

      /* Z-Index Scale */
      --z-map: 0;
      --z-controls: 100;
      --z-dropdown: 200;
      --z-popup: 300;
      --z-modal: 400;
    }

    /* Dark Theme */
    :root[data-theme="dark"] {
      --bg-void: #05070a;
      --bg-primary: #0a0e14;
      --bg-elevated: #111820;
      --bg-surface: #1a2332;

      --text-primary: #f0f4f8;
      --text-secondary: #8899a6;
      --text-muted: #4a5568;

      --accent-primary: #00d4ff;
      --accent-secondary: #ff6b6b;
      --accent-tertiary: #7c3aed;
      --accent-glow: rgba(0, 212, 255, 0.4);

      --color-call-in: #10b981;
      --color-call-out: #3b82f6;
      --color-text-in: #f59e0b;
      --color-text-out: #ec4899;

      --glass-bg: rgba(10, 14, 20, 0.85);
      --glass-border: rgba(255, 255, 255, 0.06);
      --glass-highlight: rgba(255, 255, 255, 0.03);
      --glass-shadow: rgba(0, 0, 0, 0.5);
      --glass-blur: 20px;

      --map-style: mapbox://styles/mapbox/dark-v11;
    }

    /* Light Theme */
    :root[data-theme="light"] {
      --bg-void: #f8fafc;
      --bg-primary: #ffffff;
      --bg-elevated: #ffffff;
      --bg-surface: #f1f5f9;

      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;

      --accent-primary: #0891b2;
      --accent-secondary: #e11d48;
      --accent-tertiary: #6d28d9;
      --accent-glow: rgba(8, 145, 178, 0.2);

      --color-call-in: #059669;
      --color-call-out: #2563eb;
      --color-text-in: #d97706;
      --color-text-out: #db2777;

      --glass-bg: rgba(255, 255, 255, 0.9);
      --glass-border: rgba(0, 0, 0, 0.06);
      --glass-highlight: rgba(255, 255, 255, 0.8);
      --glass-shadow: rgba(0, 0, 0, 0.08);
      --glass-blur: 16px;

      --map-style: mapbox://styles/mapbox/light-v11;
    }

    /* ============================================================
       SECTION: Map Container
       ============================================================ */
    #map {
      position: absolute;
      inset: 0;
      z-index: var(--z-map);
    }

    /* Hide Mapbox attribution in favor of custom */
    .mapboxgl-ctrl-attrib {
      display: none;
    }

    /* ============================================================
       SECTION: Glass Panel Base
       ============================================================ */
    .glass-panel {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-lg);
      box-shadow:
        0 8px 32px var(--glass-shadow),
        inset 0 1px 0 var(--glass-highlight);
      transition:
        transform var(--transition-base),
        box-shadow var(--transition-base);
    }

    .glass-panel:hover {
      transform: translateY(-1px);
      box-shadow:
        0 12px 40px var(--glass-shadow),
        inset 0 1px 0 var(--glass-highlight);
    }

    /* ============================================================
       SECTION: Control Panel Layout
       ============================================================ */
    .controls-top-left {
      position: absolute;
      top: var(--space-6);
      left: var(--space-6);
      z-index: var(--z-controls);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .controls-top-right {
      position: absolute;
      top: var(--space-6);
      right: var(--space-6);
      z-index: var(--z-controls);
    }

    .controls-bottom {
      position: absolute;
      bottom: var(--space-6);
      left: var(--space-6);
      right: var(--space-6);
      z-index: var(--z-controls);
    }

    /* ============================================================
       SECTION: Theme Toggle
       ============================================================ */
    .theme-toggle {
      width: 48px;
      height: 48px;
      border-radius: var(--radius-md);
      border: none;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-primary);
      transition: all var(--transition-fast);
      border: 1px solid var(--glass-border);
    }

    .theme-toggle:hover {
      background: var(--bg-surface);
      color: var(--accent-primary);
    }

    .theme-toggle svg {
      width: 20px;
      height: 20px;
      transition: transform var(--transition-base);
    }

    .theme-toggle:hover svg {
      transform: rotate(15deg);
    }

    .theme-toggle__sun,
    .theme-toggle__moon {
      position: absolute;
    }

    [data-theme="dark"] .theme-toggle__sun { opacity: 1; }
    [data-theme="dark"] .theme-toggle__moon { opacity: 0; }
    [data-theme="light"] .theme-toggle__sun { opacity: 0; }
    [data-theme="light"] .theme-toggle__moon { opacity: 1; }

    /* ============================================================
       SECTION: Contact Filter (NEW COMPONENT)
       ============================================================ */
    .contact-filter {
      width: 280px;
    }

    .contact-filter__header {
      padding: var(--space-4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--glass-border);
    }

    .contact-filter__title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }

    .contact-filter__count {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--accent-primary);
      background: rgba(0, 212, 255, 0.1);
      padding: 2px 8px;
      border-radius: var(--radius-full);
    }

    .contact-filter__search {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--glass-border);
    }

    .contact-filter__search-input {
      width: 100%;
      background: var(--bg-surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      padding: var(--space-2) var(--space-3);
      font-size: 13px;
      color: var(--text-primary);
      outline: none;
      transition: border-color var(--transition-fast);
    }

    .contact-filter__search-input::placeholder {
      color: var(--text-muted);
    }

    .contact-filter__search-input:focus {
      border-color: var(--accent-primary);
    }

    .contact-filter__presets {
      padding: var(--space-3) var(--space-4);
      display: flex;
      gap: var(--space-2);
      border-bottom: 1px solid var(--glass-border);
    }

    .contact-filter__preset {
      flex: 1;
      padding: var(--space-2) var(--space-3);
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .contact-filter__preset:hover {
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    .contact-filter__preset--active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-primary);
    }

    .contact-filter__list {
      max-height: 240px;
      overflow-y: auto;
      padding: var(--space-2);
    }

    .contact-filter__list::-webkit-scrollbar {
      width: 6px;
    }

    .contact-filter__list::-webkit-scrollbar-track {
      background: transparent;
    }

    .contact-filter__list::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: var(--radius-full);
    }

    .contact-filter__item {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .contact-filter__item:hover {
      background: var(--bg-surface);
    }

    .contact-filter__checkbox {
      width: 16px;
      height: 16px;
      border: 2px solid var(--text-muted);
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
      flex-shrink: 0;
    }

    .contact-filter__item--selected .contact-filter__checkbox {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
    }

    .contact-filter__checkbox-icon {
      width: 10px;
      height: 10px;
      stroke: var(--bg-primary);
      stroke-width: 3;
      opacity: 0;
      transform: scale(0.5);
      transition: all var(--transition-fast);
    }

    .contact-filter__item--selected .contact-filter__checkbox-icon {
      opacity: 1;
      transform: scale(1);
    }

    .contact-filter__contact-info {
      flex: 1;
      min-width: 0;
    }

    .contact-filter__contact-id {
      font-size: 13px;
      font-family: var(--font-mono);
      color: var(--text-primary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .contact-filter__contact-stats {
      font-size: 11px;
      color: var(--text-muted);
      display: flex;
      gap: var(--space-2);
    }

    .contact-filter__stat {
      display: flex;
      align-items: center;
      gap: 2px;
    }

    .contact-filter__stat-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .contact-filter__stat-dot--calls { background: var(--color-call-in); }
    .contact-filter__stat-dot--texts { background: var(--color-text-in); }

    /* ============================================================
       SECTION: Date/Time Picker (NEW COMPONENT)
       ============================================================ */
    .datetime-picker {
      position: relative;
    }

    .datetime-picker__trigger {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .datetime-picker__trigger:hover {
      border-color: var(--accent-primary);
    }

    .datetime-picker__trigger-icon {
      width: 18px;
      height: 18px;
      color: var(--accent-primary);
    }

    .datetime-picker__trigger-text {
      font-size: 13px;
      font-family: var(--font-mono);
      color: var(--text-primary);
    }

    .datetime-picker__dropdown {
      position: absolute;
      bottom: calc(100% + var(--space-2));
      left: 0;
      width: 320px;
      z-index: var(--z-dropdown);
      opacity: 0;
      visibility: hidden;
      transform: translateY(10px);
      transition: all var(--transition-base);
    }

    .datetime-picker--open .datetime-picker__dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .datetime-picker__presets {
      padding: var(--space-4);
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-2);
      border-bottom: 1px solid var(--glass-border);
    }

    .datetime-picker__preset {
      padding: var(--space-2) var(--space-3);
      font-size: 11px;
      font-weight: 500;
      text-align: center;
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .datetime-picker__preset:hover {
      background: var(--bg-surface);
      color: var(--text-primary);
    }

    .datetime-picker__preset--active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-primary);
    }

    .datetime-picker__calendar {
      padding: var(--space-4);
    }

    .datetime-picker__calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
    }

    .datetime-picker__nav-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg-surface);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .datetime-picker__nav-btn:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .datetime-picker__month-year {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .datetime-picker__weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
      margin-bottom: var(--space-2);
    }

    .datetime-picker__weekday {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      text-align: center;
      color: var(--text-muted);
      padding: var(--space-1);
    }

    .datetime-picker__days {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }

    .datetime-picker__day {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all var(--transition-fast);
      color: var(--text-primary);
    }

    .datetime-picker__day:hover {
      background: var(--bg-surface);
    }

    .datetime-picker__day--other-month {
      color: var(--text-muted);
    }

    .datetime-picker__day--selected {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .datetime-picker__day--in-range {
      background: rgba(0, 212, 255, 0.2);
    }

    .datetime-picker__day--today {
      border: 1px solid var(--accent-primary);
    }

    .datetime-picker__day--has-data::after {
      content: '';
      position: absolute;
      bottom: 2px;
      width: 4px;
      height: 4px;
      background: var(--accent-secondary);
      border-radius: 50%;
    }

    .datetime-picker__time {
      padding: var(--space-4);
      border-top: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .datetime-picker__time-label {
      font-size: 12px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .datetime-picker__time-inputs {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .datetime-picker__time-input {
      width: 48px;
      padding: var(--space-2);
      font-size: 14px;
      font-family: var(--font-mono);
      text-align: center;
      background: var(--bg-surface);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      outline: none;
    }

    .datetime-picker__time-input:focus {
      border-color: var(--accent-primary);
    }

    .datetime-picker__time-separator {
      font-size: 14px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    /* ============================================================
       SECTION: World Clock Display
       ============================================================ */
    .world-clock {
      padding: var(--space-4) var(--space-5);
      min-width: 200px;
    }

    .world-clock__date {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: var(--space-2);
    }

    .world-clock__time {
      font-family: var(--font-mono);
      font-size: 32px;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      display: flex;
      align-items: baseline;
    }

    .world-clock__digit {
      display: inline-block;
      min-width: 0.6em;
      text-align: center;
      transition: transform var(--transition-fast);
    }

    .world-clock__digit--flip {
      animation: digitFlip 200ms ease-out;
    }

    .world-clock__colon {
      opacity: 0.5;
      animation: colonBlink 1s step-end infinite;
    }

    .world-clock__seconds {
      font-size: 18px;
      opacity: 0.6;
      margin-left: var(--space-1);
    }

    .world-clock__timezone {
      font-size: 10px;
      color: var(--accent-primary);
      margin-top: var(--space-2);
      font-family: var(--font-mono);
    }

    @keyframes digitFlip {
      0% { transform: translateY(-100%); opacity: 0; }
      50% { transform: translateY(10%); }
      100% { transform: translateY(0); opacity: 1; }
    }

    @keyframes colonBlink {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.2; }
    }

    /* ============================================================
       SECTION: Time Slider & Controls
       ============================================================ */
    .time-controls {
      padding: var(--space-5);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }

    .time-controls__row {
      display: flex;
      align-items: center;
      gap: var(--space-4);
    }

    .time-controls__playback {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .time-controls__btn {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: var(--radius-md);
      background: var(--bg-surface);
      color: var(--text-primary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all var(--transition-fast);
    }

    .time-controls__btn:hover {
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .time-controls__btn--play {
      width: 48px;
      height: 48px;
      background: var(--accent-primary);
      color: var(--bg-primary);
    }

    .time-controls__btn--play:hover {
      background: var(--accent-secondary);
      transform: scale(1.05);
    }

    .time-controls__btn svg {
      width: 18px;
      height: 18px;
    }

    .time-controls__speed {
      display: flex;
      gap: var(--space-1);
    }

    .time-controls__speed-btn {
      padding: var(--space-1) var(--space-2);
      font-size: 11px;
      font-family: var(--font-mono);
      font-weight: 500;
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .time-controls__speed-btn:hover {
      color: var(--text-primary);
      border-color: var(--text-muted);
    }

    .time-controls__speed-btn--active {
      background: var(--accent-primary);
      border-color: var(--accent-primary);
      color: var(--bg-primary);
    }

    .time-slider {
      flex: 1;
      position: relative;
      height: 48px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .time-slider__track {
      position: relative;
      height: 6px;
      background: var(--bg-surface);
      border-radius: var(--radius-full);
      cursor: pointer;
      overflow: hidden;
    }

    .time-slider__density {
      position: absolute;
      inset: 0;
      opacity: 0.4;
    }

    .time-slider__range {
      position: absolute;
      top: 0;
      bottom: 0;
      background: rgba(0, 212, 255, 0.3);
    }

    .time-slider__progress {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      background: var(--accent-primary);
      border-radius: var(--radius-full);
    }

    .time-slider__handle {
      position: absolute;
      top: 50%;
      width: 16px;
      height: 16px;
      background: var(--text-primary);
      border: 3px solid var(--accent-primary);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: grab;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
      z-index: 2;
    }

    .time-slider__handle:hover,
    .time-slider__handle:active {
      transform: translate(-50%, -50%) scale(1.2);
      box-shadow: 0 0 20px var(--accent-glow);
    }

    .time-slider__handle:active {
      cursor: grabbing;
    }

    .time-slider__labels {
      display: flex;
      justify-content: space-between;
      margin-top: var(--space-2);
    }

    .time-slider__label {
      font-size: 10px;
      font-family: var(--font-mono);
      color: var(--text-muted);
    }

    /* ============================================================
       SECTION: Event Popups
       ============================================================ */
    .event-popup {
      min-width: 220px;
      max-width: 280px;
    }

    .event-popup__header {
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      border-bottom: 1px solid var(--glass-border);
    }

    .event-popup__icon {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .event-popup__icon--call-in { background: rgba(16, 185, 129, 0.2); color: var(--color-call-in); }
    .event-popup__icon--call-out { background: rgba(59, 130, 246, 0.2); color: var(--color-call-out); }
    .event-popup__icon--text-in { background: rgba(245, 158, 11, 0.2); color: var(--color-text-in); }
    .event-popup__icon--text-out { background: rgba(236, 72, 153, 0.2); color: var(--color-text-out); }

    .event-popup__type {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .event-popup__body {
      padding: var(--space-3) var(--space-4);
    }

    .event-popup__row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-2) 0;
    }

    .event-popup__row:not(:last-child) {
      border-bottom: 1px solid var(--glass-border);
    }

    .event-popup__label {
      font-size: 12px;
      color: var(--text-muted);
    }

    .event-popup__value {
      font-size: 12px;
      font-family: var(--font-mono);
      color: var(--text-primary);
    }

    /* ============================================================
       SECTION: Cluster Popup
       ============================================================ */
    .cluster-popup {
      min-width: 240px;
    }

    .cluster-popup__header {
      padding: var(--space-4);
      text-align: center;
      border-bottom: 1px solid var(--glass-border);
    }

    .cluster-popup__count {
      font-size: 28px;
      font-weight: 700;
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    .cluster-popup__label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-top: var(--space-1);
    }

    .cluster-popup__breakdown {
      padding: var(--space-4);
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-3);
    }

    .cluster-popup__stat {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .cluster-popup__stat-color {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .cluster-popup__stat-value {
      font-size: 13px;
      font-family: var(--font-mono);
      color: var(--text-primary);
    }

    .cluster-popup__stat-type {
      font-size: 10px;
      color: var(--text-muted);
    }

    .cluster-popup__action {
      display: block;
      width: 100%;
      padding: var(--space-3);
      background: var(--accent-primary);
      border: none;
      border-radius: 0 0 var(--radius-lg) var(--radius-lg);
      color: var(--bg-primary);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      cursor: pointer;
      transition: background var(--transition-fast);
    }

    .cluster-popup__action:hover {
      background: var(--accent-secondary);
    }

    /* ============================================================
       SECTION: Loading & Empty States
       ============================================================ */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg-void);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.5s ease;
    }

    .loading-overlay--hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 3px solid var(--glass-border);
      border-top-color: var(--accent-primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      margin-top: var(--space-4);
      font-size: 14px;
      color: var(--text-secondary);
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============================================================
       SECTION: Responsive Design
       ============================================================ */
    @media (max-width: 768px) {
      .controls-top-left {
        top: var(--space-4);
        left: var(--space-4);
      }

      .controls-top-right {
        top: var(--space-4);
        right: var(--space-4);
      }

      .controls-bottom {
        left: var(--space-4);
        right: var(--space-4);
        bottom: var(--space-4);
      }

      .contact-filter {
        width: 240px;
      }

      .world-clock__time {
        font-size: 24px;
      }

      .time-controls {
        padding: var(--space-4);
      }

      .time-controls__row {
        flex-wrap: wrap;
      }

      .datetime-picker__dropdown {
        left: auto;
        right: 0;
      }
    }

    /* ============================================================
       SECTION: Animation Entrance
       ============================================================ */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .controls-top-left {
      animation: fadeInDown 0.6s ease-out 0.3s backwards;
    }

    .controls-top-right {
      animation: fadeInDown 0.6s ease-out 0.4s backwards;
    }

    .controls-bottom {
      animation: fadeInUp 0.6s ease-out 0.5s backwards;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Initializing visualization...</div>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- Top Left Controls: Theme + Contact Filter -->
  <div class="controls-top-left">
    <!-- Theme Toggle -->
    <button class="theme-toggle glass-panel" id="themeToggle" aria-label="Toggle theme">
      <svg class="theme-toggle__sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"/>
        <line x1="12" y1="1" x2="12" y2="3"/>
        <line x1="12" y1="21" x2="12" y2="23"/>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
        <line x1="1" y1="12" x2="3" y2="12"/>
        <line x1="21" y1="12" x2="23" y2="12"/>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
      </svg>
      <svg class="theme-toggle__moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
      </svg>
    </button>

    <!-- Contact Filter -->
    <div class="contact-filter glass-panel" id="contactFilter">
      <div class="contact-filter__header">
        <span class="contact-filter__title">Contacts</span>
        <span class="contact-filter__count" id="contactCount">0/0</span>
      </div>
      <div class="contact-filter__search">
        <input
          type="text"
          class="contact-filter__search-input"
          placeholder="Search contacts..."
          id="contactSearch"
        >
      </div>
      <div class="contact-filter__presets">
        <button class="contact-filter__preset contact-filter__preset--active" data-preset="all">All</button>
        <button class="contact-filter__preset" data-preset="top10">Top 10</button>
        <button class="contact-filter__preset" data-preset="none">None</button>
      </div>
      <div class="contact-filter__list" id="contactList">
        <!-- Contact items populated by JS -->
      </div>
    </div>
  </div>

  <!-- Top Right: World Clock -->
  <div class="controls-top-right">
    <div class="world-clock glass-panel" id="worldClock">
      <div class="world-clock__date" id="clockDate">Mon, Jan 15 2025</div>
      <div class="world-clock__time">
        <span class="world-clock__digit" id="hour1">0</span>
        <span class="world-clock__digit" id="hour2">0</span>
        <span class="world-clock__colon">:</span>
        <span class="world-clock__digit" id="min1">0</span>
        <span class="world-clock__digit" id="min2">0</span>
        <span class="world-clock__seconds">
          <span class="world-clock__colon">:</span>
          <span class="world-clock__digit" id="sec1">0</span>
          <span class="world-clock__digit" id="sec2">0</span>
        </span>
      </div>
      <div class="world-clock__timezone" id="clockTimezone">UTC</div>
    </div>
  </div>

  <!-- Bottom: Time Controls -->
  <div class="controls-bottom">
    <div class="time-controls glass-panel">
      <div class="time-controls__row">
        <!-- Playback Controls -->
        <div class="time-controls__playback">
          <button class="time-controls__btn" id="stepBack" aria-label="Step backward">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 6h2v12H6V6zm3.5 6l8.5 6V6l-8.5 6z"/>
            </svg>
          </button>
          <button class="time-controls__btn time-controls__btn--play" id="playPause" aria-label="Play">
            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
              <path d="M8 5v14l11-7L8 5z"/>
            </svg>
            <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor" style="display: none;">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </button>
          <button class="time-controls__btn" id="stepForward" aria-label="Step forward">
            <svg viewBox="0 0 24 24" fill="currentColor">
              <path d="M6 18l8.5-6L6 6v12zm2 0V6l6.5 6L8 18zm10-12h2v12h-2V6z"/>
            </svg>
          </button>
        </div>

        <!-- Speed Controls -->
        <div class="time-controls__speed">
          <button class="time-controls__speed-btn" data-speed="0.5">0.5x</button>
          <button class="time-controls__speed-btn time-controls__speed-btn--active" data-speed="1">1x</button>
          <button class="time-controls__speed-btn" data-speed="2">2x</button>
          <button class="time-controls__speed-btn" data-speed="5">5x</button>
          <button class="time-controls__speed-btn" data-speed="10">10x</button>
        </div>

        <!-- Time Slider -->
        <div class="time-slider" id="timeSlider">
          <div class="time-slider__track">
            <div class="time-slider__density" id="sliderDensity"></div>
            <div class="time-slider__range" id="sliderRange"></div>
            <div class="time-slider__progress" id="sliderProgress"></div>
          </div>
          <div class="time-slider__handle" id="sliderHandle" style="left: 0%"></div>
          <div class="time-slider__labels">
            <span class="time-slider__label" id="sliderLabelStart">--</span>
            <span class="time-slider__label" id="sliderLabelEnd">--</span>
          </div>
        </div>

        <!-- Date/Time Picker -->
        <div class="datetime-picker" id="dateTimePicker">
          <div class="datetime-picker__trigger" id="dateTimePickerTrigger">
            <svg class="datetime-picker__trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
              <line x1="16" y1="2" x2="16" y2="6"/>
              <line x1="8" y1="2" x2="8" y2="6"/>
              <line x1="3" y1="10" x2="21" y2="10"/>
            </svg>
            <span class="datetime-picker__trigger-text" id="dateTimePickerText">Select Range</span>
          </div>
          <div class="datetime-picker__dropdown glass-panel" id="dateTimePickerDropdown">
            <div class="datetime-picker__presets">
              <button class="datetime-picker__preset" data-preset="today">Today</button>
              <button class="datetime-picker__preset" data-preset="yesterday">Yesterday</button>
              <button class="datetime-picker__preset" data-preset="7days">Last 7 Days</button>
              <button class="datetime-picker__preset" data-preset="30days">Last 30 Days</button>
              <button class="datetime-picker__preset" data-preset="thisMonth">This Month</button>
              <button class="datetime-picker__preset datetime-picker__preset--active" data-preset="all">All Data</button>
            </div>
            <div class="datetime-picker__calendar">
              <div class="datetime-picker__calendar-header">
                <button class="datetime-picker__nav-btn" id="calendarPrev">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                  </svg>
                </button>
                <span class="datetime-picker__month-year" id="calendarMonthYear">January 2025</span>
                <button class="datetime-picker__nav-btn" id="calendarNext">
                  <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/>
                  </svg>
                </button>
              </div>
              <div class="datetime-picker__weekdays">
                <span class="datetime-picker__weekday">Su</span>
                <span class="datetime-picker__weekday">Mo</span>
                <span class="datetime-picker__weekday">Tu</span>
                <span class="datetime-picker__weekday">We</span>
                <span class="datetime-picker__weekday">Th</span>
                <span class="datetime-picker__weekday">Fr</span>
                <span class="datetime-picker__weekday">Sa</span>
              </div>
              <div class="datetime-picker__days" id="calendarDays">
                <!-- Calendar days populated by JS -->
              </div>
            </div>
            <div class="datetime-picker__time">
              <span class="datetime-picker__time-label">Time Range</span>
              <div class="datetime-picker__time-inputs">
                <input type="text" class="datetime-picker__time-input" id="timeStart" value="00:00" maxlength="5">
                <span class="datetime-picker__time-separator">-</span>
                <input type="text" class="datetime-picker__time-input" id="timeEnd" value="23:59" maxlength="5">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============================================================
    // MODULE: Configuration & Constants
    // Could be extracted to: js/config.js
    // ============================================================
    const CONFIG = {
      MAPBOX_TOKEN: '{{MAPBOX_TOKEN}}',
      MAPBOX_STYLE_DARK: 'mapbox://styles/mapbox/dark-v11',
      MAPBOX_STYLE_LIGHT: 'mapbox://styles/mapbox/light-v11',
      ANIMATION_TICK_MS: 100,
      CLUSTER_MAX_ZOOM: 14,
      CLUSTER_RADIUS: 50,
    };

    // ============================================================
    // MODULE: EventBus
    // Could be extracted to: js/core/EventBus.js
    // Lightweight pub/sub for decoupled component communication
    // ============================================================
    const EventBus = {
      _events: {},

      on(event, callback) {
        if (!this._events[event]) this._events[event] = [];
        this._events[event].push(callback);
        return () => this.off(event, callback);
      },

      off(event, callback) {
        if (!this._events[event]) return;
        this._events[event] = this._events[event].filter(cb => cb !== callback);
      },

      emit(event, data) {
        if (!this._events[event]) return;
        this._events[event].forEach(cb => {
          try { cb(data); } catch (e) { console.error(`EventBus error in ${event}:`, e); }
        });
      },

      once(event, callback) {
        const wrapper = (data) => {
          callback(data);
          this.off(event, wrapper);
        };
        this.on(event, wrapper);
      }
    };

    // ============================================================
    // MODULE: StateManager
    // Could be extracted to: js/core/StateManager.js
    // Single source of truth for application state
    // ============================================================
    const State = {
      _state: {
        theme: 'dark',
        time: { current: null, start: null, end: null, isPlaying: false, speed: 1 },
        contacts: { all: [], selected: [], mode: 'all' },
        data: { features: [], loaded: false }
      },
      _listeners: [],

      get(path) {
        return path.split('.').reduce((obj, key) => obj?.[key], this._state);
      },

      set(path, value) {
        const keys = path.split('.');
        const lastKey = keys.pop();
        const target = keys.reduce((obj, key) => obj[key], this._state);
        target[lastKey] = value;
        this._listeners.forEach(cb => cb(path, value));
        EventBus.emit('state:change', { path, value });
      },

      subscribe(callback) {
        this._listeners.push(callback);
        return () => {
          this._listeners = this._listeners.filter(cb => cb !== callback);
        };
      }
    };

    // ============================================================
    // MODULE: ThemeController
    // Could be extracted to: js/controllers/ThemeController.js
    // ============================================================
    const ThemeController = {
      init() {
        const saved = localStorage.getItem('bandicoot-theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = saved || (prefersDark ? 'dark' : 'light');
        this.setTheme(theme);

        document.getElementById('themeToggle').addEventListener('click', () => this.toggle());
      },

      setTheme(theme) {
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('bandicoot-theme', theme);
        State.set('theme', theme);
        EventBus.emit('theme:change', { theme });
      },

      toggle() {
        const current = State.get('theme');
        this.setTheme(current === 'dark' ? 'light' : 'dark');
      }
    };

    // ============================================================
    // MODULE: MapController
    // Could be extracted to: js/controllers/MapController.js
    // ============================================================
    const MapController = {
      map: null,
      popup: null,

      async init() {
        mapboxgl.accessToken = CONFIG.MAPBOX_TOKEN;

        this.map = new mapboxgl.Map({
          container: 'map',
          style: State.get('theme') === 'dark' ? CONFIG.MAPBOX_STYLE_DARK : CONFIG.MAPBOX_STYLE_LIGHT,
          center: [0, 0],
          zoom: 2,
          attributionControl: false
        });

        this.map.addControl(new mapboxgl.NavigationControl({ showCompass: false }), 'bottom-right');

        await new Promise(resolve => this.map.on('load', resolve));

        EventBus.on('theme:change', ({ theme }) => {
          this.map.setStyle(theme === 'dark' ? CONFIG.MAPBOX_STYLE_DARK : CONFIG.MAPBOX_STYLE_LIGHT);
          this.map.once('style.load', () => this.reapplyLayers());
        });

        EventBus.on('filter:update', () => this.updateFilters());

        EventBus.emit('map:ready');
      },

      loadData(geojson) {
        // Add clustered source
        this.map.addSource('events', {
          type: 'geojson',
          data: geojson,
          cluster: true,
          clusterMaxZoom: CONFIG.CLUSTER_MAX_ZOOM,
          clusterRadius: CONFIG.CLUSTER_RADIUS,
          clusterProperties: {
            call_in: ['+', ['case', ['all', ['==', ['get', 'interaction_type'], 'call'], ['==', ['get', 'direction'], 'in']], 1, 0]],
            call_out: ['+', ['case', ['all', ['==', ['get', 'interaction_type'], 'call'], ['==', ['get', 'direction'], 'out']], 1, 0]],
            text_in: ['+', ['case', ['all', ['==', ['get', 'interaction_type'], 'text'], ['==', ['get', 'direction'], 'in']], 1, 0]],
            text_out: ['+', ['case', ['all', ['==', ['get', 'interaction_type'], 'text'], ['==', ['get', 'direction'], 'out']], 1, 0]]
          }
        });

        // Cluster circles
        this.map.addLayer({
          id: 'clusters',
          type: 'circle',
          source: 'events',
          filter: ['has', 'point_count'],
          paint: {
            'circle-color': ['step', ['get', 'point_count'],
              '#00d4ff', 10,
              '#7c3aed', 50,
              '#ff6b6b', 100,
              '#f59e0b'
            ],
            'circle-radius': ['step', ['get', 'point_count'], 20, 10, 28, 50, 36, 100, 44],
            'circle-stroke-width': 2,
            'circle-stroke-color': 'rgba(255, 255, 255, 0.2)'
          }
        });

        // Cluster count labels
        this.map.addLayer({
          id: 'cluster-count',
          type: 'symbol',
          source: 'events',
          filter: ['has', 'point_count'],
          layout: {
            'text-field': ['get', 'point_count_abbreviated'],
            'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold'],
            'text-size': 13
          },
          paint: { 'text-color': '#ffffff' }
        });

        // Individual points
        this.map.addLayer({
          id: 'unclustered-point',
          type: 'circle',
          source: 'events',
          filter: ['!', ['has', 'point_count']],
          paint: {
            'circle-radius': 7,
            'circle-color': ['match', ['concat', ['get', 'interaction_type'], '-', ['get', 'direction']],
              'call-in', '#10b981',
              'call-out', '#3b82f6',
              'text-in', '#f59e0b',
              'text-out', '#ec4899',
              '#00d4ff'
            ],
            'circle-stroke-width': 2,
            'circle-stroke-color': 'rgba(255, 255, 255, 0.4)'
          }
        });

        // Click handlers
        this.map.on('click', 'clusters', (e) => this.handleClusterClick(e));
        this.map.on('click', 'unclustered-point', (e) => this.handlePointClick(e));
        this.map.on('mouseenter', 'clusters', () => this.map.getCanvas().style.cursor = 'pointer');
        this.map.on('mouseleave', 'clusters', () => this.map.getCanvas().style.cursor = '');
        this.map.on('mouseenter', 'unclustered-point', () => this.map.getCanvas().style.cursor = 'pointer');
        this.map.on('mouseleave', 'unclustered-point', () => this.map.getCanvas().style.cursor = '');

        // Fit to data bounds
        const bounds = new mapboxgl.LngLatBounds();
        geojson.features.forEach(f => bounds.extend(f.geometry.coordinates));
        this.map.fitBounds(bounds, { padding: 50, maxZoom: 12 });
      },

      handleClusterClick(e) {
        const features = this.map.queryRenderedFeatures(e.point, { layers: ['clusters'] });
        if (!features.length) return;

        const cluster = features[0];
        const source = this.map.getSource('events');

        source.getClusterExpansionZoom(cluster.properties.cluster_id, (err, zoom) => {
          if (err) return;
          this.map.easeTo({ center: cluster.geometry.coordinates, zoom: zoom + 1 });
        });
      },

      handlePointClick(e) {
        const feature = e.features[0];
        const props = feature.properties;
        const type = props.interaction_type;
        const dir = props.direction;
        const iconClass = `event-popup__icon--${type}-${dir}`;
        const typeLabel = `${dir === 'in' ? 'Incoming' : 'Outgoing'} ${type === 'call' ? 'Call' : 'Text'}`;

        const date = new Date(props.timestamp);
        const dateStr = date.toLocaleDateString('en-US', {
          weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
        });
        const timeStr = date.toLocaleTimeString('en-US', {
          hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
        });

        const durationHtml = type === 'call' && props.duration ? `
          <div class="event-popup__row">
            <span class="event-popup__label">Duration</span>
            <span class="event-popup__value">${this.formatDuration(props.duration)}</span>
          </div>
        ` : '';

        const html = `
          <div class="event-popup glass-panel">
            <div class="event-popup__header">
              <div class="event-popup__icon ${iconClass}">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                  ${type === 'call'
                    ? '<path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56-.35-.12-.74-.03-1.01.24l-1.57 1.97c-2.83-1.35-5.48-3.9-6.89-6.83l1.95-1.66c.27-.28.35-.67.24-1.02-.37-1.11-.56-2.3-.56-3.53 0-.54-.45-.99-.99-.99H4.19C3.65 3 3 3.24 3 3.99 3 13.28 10.73 21 20.01 21c.71 0 .99-.63.99-1.18v-3.45c0-.54-.45-.99-.99-.99z"/>'
                    : '<path d="M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-2 12H6v-2h12v2zm0-3H6V9h12v2zm0-3H6V6h12v2z"/>'
                  }
                </svg>
              </div>
              <div class="event-popup__type">${typeLabel}</div>
            </div>
            <div class="event-popup__body">
              <div class="event-popup__row">
                <span class="event-popup__label">Date</span>
                <span class="event-popup__value">${dateStr}</span>
              </div>
              <div class="event-popup__row">
                <span class="event-popup__label">Time</span>
                <span class="event-popup__value">${timeStr}</span>
              </div>
              ${durationHtml}
              <div class="event-popup__row">
                <span class="event-popup__label">Contact</span>
                <span class="event-popup__value">${props.correspondent_id}</span>
              </div>
              <div class="event-popup__row">
                <span class="event-popup__label">Antenna</span>
                <span class="event-popup__value">${props.antenna_id || 'Unknown'}</span>
              </div>
            </div>
          </div>
        `;

        if (this.popup) this.popup.remove();
        this.popup = new mapboxgl.Popup({ closeButton: false, maxWidth: '300px' })
          .setLngLat(feature.geometry.coordinates)
          .setHTML(html)
          .addTo(this.map);
      },

      formatDuration(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
      },

      updateFilters() {
        const currentTime = State.get('time.current');
        const startTime = State.get('time.start');
        const endTime = State.get('time.end');
        const selectedContacts = State.get('contacts.selected');
        const contactMode = State.get('contacts.mode');

        if (!this.map.getSource('events')) return;

        let filter = ['all'];

        // Time filter
        if (currentTime) {
          filter.push(['<=', ['get', 'timestamp'], currentTime]);
        }

        // Contact filter
        if (contactMode === 'selected' && selectedContacts.length > 0) {
          filter.push(['in', ['get', 'correspondent_id'], ['literal', selectedContacts]]);
        }

        // Apply to layers
        const clusterFilter = ['all', ['has', 'point_count']];
        const pointFilter = ['all', ['!', ['has', 'point_count']], ...filter.slice(1)];

        this.map.setFilter('unclustered-point', pointFilter);
      },

      reapplyLayers() {
        const data = State.get('data.features');
        if (data.length > 0) {
          const geojson = { type: 'FeatureCollection', features: data };
          if (this.map.getSource('events')) {
            this.map.getSource('events').setData(geojson);
          } else {
            this.loadData(geojson);
          }
        }
      }
    };

    // ============================================================
    // MODULE: TimeController
    // Could be extracted to: js/controllers/TimeController.js
    // ============================================================
    const TimeController = {
      animationId: null,
      lastFrameTime: 0,

      init() {
        EventBus.on('data:loaded', ({ timeRange }) => {
          State.set('time.start', timeRange.start);
          State.set('time.end', timeRange.end);
          State.set('time.current', timeRange.start);
          this.updateClock(timeRange.start);
        });

        // Play/Pause button
        document.getElementById('playPause').addEventListener('click', () => this.togglePlay());

        // Speed buttons
        document.querySelectorAll('.time-controls__speed-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            document.querySelectorAll('.time-controls__speed-btn').forEach(b =>
              b.classList.remove('time-controls__speed-btn--active'));
            btn.classList.add('time-controls__speed-btn--active');
            State.set('time.speed', parseFloat(btn.dataset.speed));
          });
        });

        // Step buttons
        document.getElementById('stepBack').addEventListener('click', () => this.step(-1));
        document.getElementById('stepForward').addEventListener('click', () => this.step(1));

        EventBus.on('time:seek', ({ timestamp }) => {
          State.set('time.current', timestamp);
          this.updateClock(timestamp);
          EventBus.emit('filter:update');
        });
      },

      togglePlay() {
        const isPlaying = State.get('time.isPlaying');
        if (isPlaying) {
          this.pause();
        } else {
          this.play();
        }
      },

      play() {
        State.set('time.isPlaying', true);
        document.querySelector('.play-icon').style.display = 'none';
        document.querySelector('.pause-icon').style.display = 'block';
        this.lastFrameTime = performance.now();
        this.animate();
      },

      pause() {
        State.set('time.isPlaying', false);
        document.querySelector('.play-icon').style.display = 'block';
        document.querySelector('.pause-icon').style.display = 'none';
        if (this.animationId) {
          cancelAnimationFrame(this.animationId);
          this.animationId = null;
        }
      },

      animate() {
        if (!State.get('time.isPlaying')) return;

        const now = performance.now();
        const delta = now - this.lastFrameTime;
        this.lastFrameTime = now;

        const speed = State.get('time.speed');
        const current = State.get('time.current');
        const end = State.get('time.end');

        // Each real second = 1 hour of data time at 1x speed
        const dataTimeDelta = (delta / 1000) * 3600000 * speed;
        const newTime = Math.min(current + dataTimeDelta, end);

        State.set('time.current', newTime);
        this.updateClock(newTime);
        TimeSlider.updatePosition(newTime);
        EventBus.emit('filter:update');

        if (newTime >= end) {
          this.pause();
        } else {
          this.animationId = requestAnimationFrame(() => this.animate());
        }
      },

      step(direction) {
        const current = State.get('time.current');
        const start = State.get('time.start');
        const end = State.get('time.end');
        const stepSize = 3600000; // 1 hour

        const newTime = Math.max(start, Math.min(end, current + (stepSize * direction)));
        EventBus.emit('time:seek', { timestamp: newTime });
      },

      updateClock(timestamp) {
        const date = new Date(timestamp);

        const dateStr = date.toLocaleDateString('en-US', {
          weekday: 'short', month: 'short', day: 'numeric', year: 'numeric'
        });
        document.getElementById('clockDate').textContent = dateStr;

        const hours = String(date.getHours()).padStart(2, '0');
        const mins = String(date.getMinutes()).padStart(2, '0');
        const secs = String(date.getSeconds()).padStart(2, '0');

        this.updateDigit('hour1', hours[0]);
        this.updateDigit('hour2', hours[1]);
        this.updateDigit('min1', mins[0]);
        this.updateDigit('min2', mins[1]);
        this.updateDigit('sec1', secs[0]);
        this.updateDigit('sec2', secs[1]);

        document.getElementById('clockTimezone').textContent =
          Intl.DateTimeFormat().resolvedOptions().timeZone;
      },

      updateDigit(id, value) {
        const el = document.getElementById(id);
        if (el.textContent !== value) {
          el.classList.add('world-clock__digit--flip');
          el.textContent = value;
          setTimeout(() => el.classList.remove('world-clock__digit--flip'), 200);
        }
      }
    };

    // ============================================================
    // MODULE: TimeSlider
    // Could be extracted to: js/components/TimeSlider.js
    // ============================================================
    const TimeSlider = {
      isDragging: false,

      init() {
        const slider = document.getElementById('timeSlider');
        const handle = document.getElementById('sliderHandle');
        const track = slider.querySelector('.time-slider__track');

        handle.addEventListener('mousedown', (e) => this.startDrag(e));
        track.addEventListener('click', (e) => this.handleTrackClick(e));

        document.addEventListener('mousemove', (e) => this.drag(e));
        document.addEventListener('mouseup', () => this.endDrag());

        // Touch support
        handle.addEventListener('touchstart', (e) => this.startDrag(e));
        document.addEventListener('touchmove', (e) => this.drag(e));
        document.addEventListener('touchend', () => this.endDrag());

        EventBus.on('data:loaded', ({ timeRange, density }) => {
          this.renderDensity(density);
          this.updateLabels(timeRange.start, timeRange.end);
        });
      },

      startDrag(e) {
        e.preventDefault();
        this.isDragging = true;
        document.getElementById('sliderHandle').style.transform = 'translate(-50%, -50%) scale(1.2)';
      },

      drag(e) {
        if (!this.isDragging) return;

        const track = document.querySelector('.time-slider__track');
        const rect = track.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const position = Math.max(0, Math.min(1, (clientX - rect.left) / rect.width));

        const start = State.get('time.start');
        const end = State.get('time.end');
        const timestamp = start + (end - start) * position;

        EventBus.emit('time:seek', { timestamp });
      },

      endDrag() {
        this.isDragging = false;
        document.getElementById('sliderHandle').style.transform = 'translate(-50%, -50%)';
      },

      handleTrackClick(e) {
        const track = e.currentTarget;
        const rect = track.getBoundingClientRect();
        const position = (e.clientX - rect.left) / rect.width;

        const start = State.get('time.start');
        const end = State.get('time.end');
        const timestamp = start + (end - start) * position;

        EventBus.emit('time:seek', { timestamp });
      },

      updatePosition(timestamp) {
        const start = State.get('time.start');
        const end = State.get('time.end');
        const position = ((timestamp - start) / (end - start)) * 100;

        document.getElementById('sliderHandle').style.left = `${position}%`;
        document.getElementById('sliderProgress').style.width = `${position}%`;
      },

      renderDensity(density) {
        if (!density || density.length === 0) return;

        const maxCount = Math.max(...density.map(d => d.count));
        const stops = density.map((d, i) => {
          const position = (i / (density.length - 1)) * 100;
          const intensity = d.count / maxCount;
          const alpha = 0.1 + intensity * 0.5;
          return `rgba(0, 212, 255, ${alpha}) ${position}%`;
        });

        document.getElementById('sliderDensity').style.background =
          `linear-gradient(to right, ${stops.join(', ')})`;
      },

      updateLabels(start, end) {
        const formatDate = (ts) => new Date(ts).toLocaleDateString('en-US', {
          month: 'short', day: 'numeric', year: 'numeric'
        });

        document.getElementById('sliderLabelStart').textContent = formatDate(start);
        document.getElementById('sliderLabelEnd').textContent = formatDate(end);
      }
    };

    // ============================================================
    // MODULE: ContactFilter (NEW)
    // Could be extracted to: js/components/ContactFilter.js
    // ============================================================
    const ContactFilter = {
      contacts: [],

      init() {
        EventBus.on('data:loaded', ({ contacts }) => {
          this.contacts = contacts;
          this.render();
          this.updateCount();
        });

        // Search input
        document.getElementById('contactSearch').addEventListener('input', (e) => {
          this.filterList(e.target.value);
        });

        // Preset buttons
        document.querySelectorAll('.contact-filter__preset').forEach(btn => {
          btn.addEventListener('click', () => this.handlePreset(btn.dataset.preset));
        });
      },

      render() {
        const list = document.getElementById('contactList');
        list.innerHTML = '';

        this.contacts.forEach(contact => {
          const item = document.createElement('div');
          item.className = 'contact-filter__item contact-filter__item--selected';
          item.dataset.id = contact.id;
          item.innerHTML = `
            <div class="contact-filter__checkbox">
              <svg class="contact-filter__checkbox-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
            </div>
            <div class="contact-filter__contact-info">
              <div class="contact-filter__contact-id">${contact.id}</div>
              <div class="contact-filter__contact-stats">
                <span class="contact-filter__stat">
                  <span class="contact-filter__stat-dot contact-filter__stat-dot--calls"></span>
                  ${contact.calls}
                </span>
                <span class="contact-filter__stat">
                  <span class="contact-filter__stat-dot contact-filter__stat-dot--texts"></span>
                  ${contact.texts}
                </span>
              </div>
            </div>
          `;

          item.addEventListener('click', () => this.toggleContact(contact.id, item));
          list.appendChild(item);
        });
      },

      toggleContact(id, item) {
        item.classList.toggle('contact-filter__item--selected');
        const selected = State.get('contacts.selected');

        if (item.classList.contains('contact-filter__item--selected')) {
          State.set('contacts.selected', [...selected, id]);
        } else {
          State.set('contacts.selected', selected.filter(c => c !== id));
        }

        State.set('contacts.mode', 'selected');
        this.updatePresetButtons('');
        this.updateCount();
        EventBus.emit('filter:update');
      },

      handlePreset(preset) {
        this.updatePresetButtons(preset);
        const items = document.querySelectorAll('.contact-filter__item');

        switch (preset) {
          case 'all':
            items.forEach(item => item.classList.add('contact-filter__item--selected'));
            State.set('contacts.mode', 'all');
            State.set('contacts.selected', this.contacts.map(c => c.id));
            break;
          case 'none':
            items.forEach(item => item.classList.remove('contact-filter__item--selected'));
            State.set('contacts.mode', 'selected');
            State.set('contacts.selected', []);
            break;
          case 'top10':
            const top10 = this.contacts.slice(0, 10).map(c => c.id);
            items.forEach(item => {
              if (top10.includes(item.dataset.id)) {
                item.classList.add('contact-filter__item--selected');
              } else {
                item.classList.remove('contact-filter__item--selected');
              }
            });
            State.set('contacts.mode', 'selected');
            State.set('contacts.selected', top10);
            break;
        }

        this.updateCount();
        EventBus.emit('filter:update');
      },

      updatePresetButtons(active) {
        document.querySelectorAll('.contact-filter__preset').forEach(btn => {
          btn.classList.toggle('contact-filter__preset--active', btn.dataset.preset === active);
        });
      },

      filterList(query) {
        const items = document.querySelectorAll('.contact-filter__item');
        const lowerQuery = query.toLowerCase();

        items.forEach(item => {
          const id = item.dataset.id.toLowerCase();
          item.style.display = id.includes(lowerQuery) ? 'flex' : 'none';
        });
      },

      updateCount() {
        const selected = document.querySelectorAll('.contact-filter__item--selected').length;
        const total = this.contacts.length;
        document.getElementById('contactCount').textContent = `${selected}/${total}`;
      }
    };

    // ============================================================
    // MODULE: DateTimePicker (NEW)
    // Could be extracted to: js/components/DateTimePicker.js
    // ============================================================
    const DateTimePicker = {
      isOpen: false,
      currentMonth: new Date(),
      dataRange: { start: null, end: null },

      init() {
        const trigger = document.getElementById('dateTimePickerTrigger');
        const dropdown = document.getElementById('dateTimePickerDropdown');

        trigger.addEventListener('click', () => this.toggle());

        // Close on outside click
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.datetime-picker') && this.isOpen) {
            this.close();
          }
        });

        // Navigation
        document.getElementById('calendarPrev').addEventListener('click', (e) => {
          e.stopPropagation();
          this.navigateMonth(-1);
        });
        document.getElementById('calendarNext').addEventListener('click', (e) => {
          e.stopPropagation();
          this.navigateMonth(1);
        });

        // Presets
        document.querySelectorAll('.datetime-picker__preset').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            this.handlePreset(btn.dataset.preset);
          });
        });

        EventBus.on('data:loaded', ({ timeRange }) => {
          this.dataRange = timeRange;
          this.currentMonth = new Date(timeRange.start);
          this.updateTriggerText();
        });
      },

      toggle() {
        this.isOpen ? this.close() : this.open();
      },

      open() {
        this.isOpen = true;
        document.getElementById('dateTimePicker').classList.add('datetime-picker--open');
        this.renderCalendar();
      },

      close() {
        this.isOpen = false;
        document.getElementById('dateTimePicker').classList.remove('datetime-picker--open');
      },

      navigateMonth(delta) {
        this.currentMonth.setMonth(this.currentMonth.getMonth() + delta);
        this.renderCalendar();
      },

      renderCalendar() {
        const year = this.currentMonth.getFullYear();
        const month = this.currentMonth.getMonth();

        document.getElementById('calendarMonthYear').textContent =
          this.currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const daysInPrevMonth = new Date(year, month, 0).getDate();

        const container = document.getElementById('calendarDays');
        container.innerHTML = '';

        // Previous month days
        for (let i = firstDay - 1; i >= 0; i--) {
          const day = daysInPrevMonth - i;
          container.appendChild(this.createDayElement(day, 'other-month'));
        }

        // Current month days
        const today = new Date();
        for (let day = 1; day <= daysInMonth; day++) {
          const date = new Date(year, month, day);
          const classes = [];

          if (date.toDateString() === today.toDateString()) {
            classes.push('today');
          }

          // Check if date has data
          if (this.dataRange.start && this.dataRange.end) {
            const dayStart = date.getTime();
            const dayEnd = dayStart + 86400000;
            if (dayStart >= this.dataRange.start && dayEnd <= this.dataRange.end) {
              classes.push('has-data');
            }
          }

          const el = this.createDayElement(day, classes.join(' '));
          el.addEventListener('click', () => this.selectDate(date));
          container.appendChild(el);
        }

        // Next month days
        const totalCells = 42;
        const remaining = totalCells - container.children.length;
        for (let day = 1; day <= remaining; day++) {
          container.appendChild(this.createDayElement(day, 'other-month'));
        }
      },

      createDayElement(day, className) {
        const el = document.createElement('div');
        el.className = `datetime-picker__day ${className ? 'datetime-picker__day--' + className.replace(/ /g, ' datetime-picker__day--') : ''}`;
        el.textContent = day;
        return el;
      },

      selectDate(date) {
        // Simple single-date selection for now
        const start = date.getTime();
        const end = start + 86400000 - 1;

        State.set('time.start', start);
        State.set('time.end', end);
        State.set('time.current', start);

        TimeSlider.updateLabels(start, end);
        TimeController.updateClock(start);
        EventBus.emit('filter:update');

        this.updateTriggerText();
        this.updatePresetButtons('');
      },

      handlePreset(preset) {
        this.updatePresetButtons(preset);

        const now = new Date();
        let start, end;

        switch (preset) {
          case 'today':
            start = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            end = start + 86400000 - 1;
            break;
          case 'yesterday':
            end = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime() - 1;
            start = end - 86400000 + 1;
            break;
          case '7days':
            end = now.getTime();
            start = end - 7 * 86400000;
            break;
          case '30days':
            end = now.getTime();
            start = end - 30 * 86400000;
            break;
          case 'thisMonth':
            start = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59).getTime();
            break;
          case 'all':
            start = this.dataRange.start;
            end = this.dataRange.end;
            break;
        }

        // Clamp to data range
        start = Math.max(start, this.dataRange.start);
        end = Math.min(end, this.dataRange.end);

        State.set('time.start', start);
        State.set('time.end', end);
        State.set('time.current', start);

        TimeSlider.updateLabels(start, end);
        TimeController.updateClock(start);
        EventBus.emit('filter:update');

        this.updateTriggerText();
      },

      updatePresetButtons(active) {
        document.querySelectorAll('.datetime-picker__preset').forEach(btn => {
          btn.classList.toggle('datetime-picker__preset--active', btn.dataset.preset === active);
        });
      },

      updateTriggerText() {
        const start = State.get('time.start');
        const end = State.get('time.end');

        if (!start || !end) {
          document.getElementById('dateTimePickerText').textContent = 'Select Range';
          return;
        }

        const startDate = new Date(start);
        const endDate = new Date(end);

        const formatShort = (d) => d.toLocaleDateString('en-US', {
          month: 'short', day: 'numeric'
        });

        if (startDate.toDateString() === endDate.toDateString()) {
          document.getElementById('dateTimePickerText').textContent = formatShort(startDate);
        } else {
          document.getElementById('dateTimePickerText').textContent =
            `${formatShort(startDate)} - ${formatShort(endDate)}`;
        }
      }
    };

    // ============================================================
    // MODULE: DataLoader
    // Could be extracted to: js/data/DataLoader.js
    // ============================================================
    const DataLoader = {
      load(geojson) {
        const features = geojson.features;

        // Calculate time range
        let minTime = Infinity, maxTime = -Infinity;
        features.forEach(f => {
          const t = f.properties.timestamp;
          if (t < minTime) minTime = t;
          if (t > maxTime) maxTime = t;
        });

        // Calculate event density (hourly buckets)
        const bucketMs = 3600000;
        const buckets = new Map();
        features.forEach(f => {
          const t = f.properties.timestamp;
          const bucket = Math.floor(t / bucketMs) * bucketMs;
          buckets.set(bucket, (buckets.get(bucket) || 0) + 1);
        });
        const density = Array.from(buckets.entries())
          .map(([time, count]) => ({ time, count }))
          .sort((a, b) => a.time - b.time);

        // Extract unique contacts with stats
        const contactStats = new Map();
        features.forEach(f => {
          const id = f.properties.correspondent_id;
          if (!contactStats.has(id)) {
            contactStats.set(id, { id, calls: 0, texts: 0, total: 0 });
          }
          const stats = contactStats.get(id);
          if (f.properties.interaction_type === 'call') stats.calls++;
          else stats.texts++;
          stats.total++;
        });
        const contacts = Array.from(contactStats.values())
          .sort((a, b) => b.total - a.total);

        // Update state
        State.set('data.features', features);
        State.set('data.loaded', true);
        State.set('contacts.all', contacts);
        State.set('contacts.selected', contacts.map(c => c.id));

        // Emit loaded event
        EventBus.emit('data:loaded', {
          features,
          timeRange: { start: minTime, end: maxTime },
          density,
          contacts
        });

        // Load into map
        MapController.loadData(geojson);
      }
    };

    // ============================================================
    // MODULE: Application Bootstrap
    // Could be extracted to: js/main.js
    // ============================================================
    async function init() {
      try {
        // Initialize modules
        ThemeController.init();
        await MapController.init();
        TimeController.init();
        TimeSlider.init();
        ContactFilter.init();
        DateTimePicker.init();

        // Load embedded data if available
        if (window.BANDICOOT_DATA) {
          DataLoader.load(window.BANDICOOT_DATA);
        }

        // Hide loading overlay
        setTimeout(() => {
          document.getElementById('loadingOverlay').classList.add('loading-overlay--hidden');
        }, 500);

        console.log('Bandicoot CDR Visualization initialized');
      } catch (error) {
        console.error('Failed to initialize:', error);
        document.querySelector('.loading-text').textContent =
          'Failed to initialize. Check console for details.';
      }
    }

    document.addEventListener('DOMContentLoaded', init);

    // ============================================================
    // DATA: Embedded GeoJSON
    // This section is populated by the Python generation script
    // ============================================================
    window.BANDICOOT_DATA = {{GEOJSON_DATA}};
  </script>
</body>
</html>
```

---

## Data Format Specification

### GeoJSON Feature Structure

```javascript
{
  "type": "FeatureCollection",
  "metadata": {
    "user_id": "ego",
    "generated_at": "2025-01-15T14:30:00Z",
    "total_records": 1247,
    "records_with_location": 1198,
    "date_range": {
      "start": "2024-01-01T00:00:00Z",
      "end": "2024-03-15T23:59:59Z"
    }
  },
  "features": [
    {
      "type": "Feature",
      "geometry": {
        "type": "Point",
        "coordinates": [-122.4194, 37.7749]  // [longitude, latitude]
      },
      "properties": {
        "antenna_id": "tower_142",
        "datetime": "2024-01-15T14:30:45Z",
        "timestamp": 1705328245000,  // Unix timestamp in milliseconds
        "interaction_type": "call",  // "call" or "text"
        "direction": "in",           // "in" or "out"
        "duration": 222,             // seconds (calls only, null for texts)
        "correspondent_id": "contact_a7b3c9d2"  // anonymized contact ID
      }
    }
  ]
}
```

### Required Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `geometry.coordinates` | `[number, number]` | Yes | `[longitude, latitude]` |
| `properties.timestamp` | `number` | Yes | Unix timestamp in milliseconds |
| `properties.interaction_type` | `string` | Yes | `"call"` or `"text"` |
| `properties.direction` | `string` | Yes | `"in"` or `"out"` |
| `properties.correspondent_id` | `string` | Yes | Contact identifier |
| `properties.antenna_id` | `string` | No | Antenna/tower identifier |
| `properties.duration` | `number` | No | Call duration in seconds |

---

## Contact Filter Component Specification

### Purpose

The Contact Filter allows users to isolate visualization to specific correspondents, enabling analysis of communication patterns with particular contacts.

### Features

1. **Multi-select list** - Check/uncheck individual contacts
2. **Search** - Filter contact list by ID
3. **Presets** - Quick filters for common selections:
   - **All** - Show all contacts
   - **Top 10** - Show 10 most frequent contacts
   - **None** - Clear all selections
4. **Stats display** - Show call/text count per contact
5. **Selection counter** - Display "X/Y selected"

### State Management

```javascript
State.contacts = {
  all: [                    // All contacts extracted from data
    { id: 'contact_001', calls: 45, texts: 32, total: 77 },
    { id: 'contact_002', calls: 12, texts: 89, total: 101 },
    // ...
  ],
  selected: ['contact_001', 'contact_002'],  // Currently selected contact IDs
  mode: 'all' | 'selected' | 'top10'         // Current filter mode
};
```

### Events

| Event | Payload | Description |
|-------|---------|-------------|
| `filter:contacts:change` | `{ selected: string[], mode: string }` | Contact selection changed |
| `filter:update` | - | Trigger map filter update |

### Interaction Flow

1. User opens contact filter panel
2. Contacts listed with interaction counts, sorted by frequency
3. User can:
   - Click individual contacts to toggle
   - Use preset buttons for quick selection
   - Search to find specific contacts
4. Map updates in real-time as selections change

---

## Date/Time Picker Component Specification

### Purpose

The Date/Time Picker provides precise temporal control beyond what the time slider offers, allowing users to select specific date ranges and times.

### Features

1. **Calendar view** - Visual date selection with month navigation
2. **Time inputs** - Start and end time selection
3. **Presets** - Quick date range selections:
   - Today
   - Yesterday
   - Last 7 Days
   - Last 30 Days
   - This Month
   - All Data
4. **Data indicators** - Visual markers on days that have data
5. **Range clamping** - Selections constrained to available data range

### State Integration

The Date/Time Picker modifies `State.time.start` and `State.time.end`, which are the bounds for playback and filtering.

### Events

| Event | Payload | Description |
|-------|---------|-------------|
| `time:range:change` | `{ start: number, end: number }` | Date range changed |
| `filter:update` | - | Trigger map filter update |

### Calendar Rendering

```javascript
renderCalendar() {
  // 1. Get first day of month and days in month
  // 2. Render previous month's trailing days (grayed out)
  // 3. Render current month days with:
  //    - Today marker
  //    - Data availability indicator
  //    - Selected state highlighting
  // 4. Render next month's leading days (grayed out)
}
```

---

## Python Generation Function

This Python function transforms Bandicoot user data into the self-contained HTML visualization file.

```python
# scripts/generate_visualization.py
"""
Generate self-contained HTML visualization from Bandicoot user data.

Usage:
    conda run -n bandicoot python -c "
    import bandicoot as bc
    from scripts.generate_visualization import generate_visualization

    user = bc.read_csv('ego', 'demo/data/', 'demo/data/antennas.csv')
    generate_visualization(user, 'visualization.html', mapbox_token='pk.xxx')
    print('Open visualization.html in your browser')
    "
"""

import json
import hashlib
from datetime import datetime
from pathlib import Path


def hash_contact(correspondent_id: str, salt: str = '') -> str:
    """Hash contact ID for privacy."""
    return hashlib.sha256(f"{salt}{correspondent_id}".encode()).hexdigest()[:12]


def bandicoot_to_geojson(user, anonymize: bool = True, salt: str = '') -> dict:
    """
    Transform Bandicoot User object to GeoJSON FeatureCollection.

    Args:
        user: Bandicoot User object
        anonymize: Whether to hash contact IDs
        salt: Salt for contact ID hashing

    Returns:
        dict: GeoJSON FeatureCollection
    """
    features = []
    skipped_no_location = 0

    for record in user.records:
        # Skip records without location
        if record.position is None:
            skipped_no_location += 1
            continue

        # Get contact ID (anonymized if requested)
        contact_id = record.correspondent_id
        if anonymize:
            contact_id = f"contact_{hash_contact(contact_id, salt)}"

        # Build feature
        feature = {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [
                    record.position.antenna.longitude,
                    record.position.antenna.latitude
                ]
            },
            "properties": {
                "antenna_id": record.position.antenna.antenna_id if record.position.antenna else None,
                "datetime": record.datetime.isoformat() + 'Z',
                "timestamp": int(record.datetime.timestamp() * 1000),
                "interaction_type": record.interaction,
                "direction": record.direction,
                "duration": record.call_duration if record.interaction == 'call' else None,
                "correspondent_id": contact_id
            }
        }
        features.append(feature)

    # Calculate time range
    timestamps = [f["properties"]["timestamp"] for f in features]

    return {
        "type": "FeatureCollection",
        "metadata": {
            "user_id": user.name,
            "generated_at": datetime.utcnow().isoformat() + 'Z',
            "total_records": len(user.records),
            "records_with_location": len(features),
            "records_skipped": skipped_no_location,
            "date_range": {
                "start": datetime.fromtimestamp(min(timestamps) / 1000).isoformat() + 'Z' if timestamps else None,
                "end": datetime.fromtimestamp(max(timestamps) / 1000).isoformat() + 'Z' if timestamps else None
            }
        },
        "features": features
    }


def generate_visualization(
    user,
    output_path: str,
    mapbox_token: str,
    anonymize: bool = True,
    salt: str = ''
) -> str:
    """
    Generate self-contained HTML visualization file.

    Args:
        user: Bandicoot User object
        output_path: Path to output HTML file
        mapbox_token: Mapbox access token (pk.xxx format)
        anonymize: Whether to anonymize contact IDs
        salt: Salt for contact ID hashing

    Returns:
        str: Path to generated file
    """
    # Convert to GeoJSON
    geojson = bandicoot_to_geojson(user, anonymize, salt)

    # Load HTML template
    template_path = Path(__file__).parent.parent / 'resources' / 'visualization-template.html'

    # If template doesn't exist, use embedded template (the HTML above)
    if not template_path.exists():
        raise FileNotFoundError(
            f"Template not found at {template_path}. "
            "Ensure visualization-template.html is in resources/"
        )

    with open(template_path, 'r', encoding='utf-8') as f:
        html = f.read()

    # Inject data and token
    html = html.replace('{{MAPBOX_TOKEN}}', mapbox_token)
    html = html.replace('{{USER_ID}}', user.name)
    html = html.replace('{{GEOJSON_DATA}}', json.dumps(geojson, separators=(',', ':')))

    # Write output
    output = Path(output_path)
    with open(output, 'w', encoding='utf-8') as f:
        f.write(html)

    print(f"Generated visualization: {output.absolute()}")
    print(f"  Records visualized: {geojson['metadata']['records_with_location']}")
    print(f"  Records skipped (no location): {geojson['metadata']['records_skipped']}")
    print(f"  Date range: {geojson['metadata']['date_range']['start']} to {geojson['metadata']['date_range']['end']}")

    return str(output.absolute())


# Inline execution example (for command integration)
if __name__ == '__main__':
    import sys
    import bandicoot as bc

    if len(sys.argv) < 5:
        print("Usage: python generate_visualization.py <user_id> <records_path> <antennas_path> <mapbox_token> [output_path]")
        sys.exit(1)

    user_id = sys.argv[1]
    records_path = sys.argv[2]
    antennas_path = sys.argv[3]
    mapbox_token = sys.argv[4]
    output_path = sys.argv[5] if len(sys.argv) > 5 else f'{user_id}_visualization.html'

    user = bc.read_csv(user_id, records_path, antennas_path)
    generate_visualization(user, output_path, mapbox_token)
```

---

## Plugin Command Integration

Create `commands/visualize-map.md`:

```yaml
---
description: Generate interactive Mapbox GL JS map visualization of CDR location data
argument-hint: <user_id> <records_path> <antennas_path> [--output=visualization.html] [--token=MAPBOX_TOKEN]
allowed-tools: Bash, Read, Write
---

# Map Visualization

Generate a self-contained HTML file that visualizes CDR location data on an interactive Mapbox map.

## Requirements

- Mapbox access token (public token starting with `pk.`)
- CDR records with antenna/location data
- Antennas file with coordinates

## Usage

```bash
conda run -n bandicoot python scripts/generate_visualization.py \
  ego \
  demo/data/ \
  demo/data/antennas.csv \
  "pk.your_mapbox_token_here" \
  visualization.html
```

Then open `visualization.html` in your browser.

## Features

- Full-viewport interactive map
- Time slider with animation playback
- Contact filtering (multi-select)
- Date/time picker with presets
- Dark/light theme toggle
- Cluster visualization
- Event popups with details

## Output

Single self-contained HTML file that can be:
- Opened directly in any modern browser
- Shared without any server requirements
- Embedded in reports or presentations
```

---

## Implementation Timeline

| Day | Focus | Deliverables |
|-----|-------|--------------|
| 1 | Core Structure | HTML template, CSS variables, theme system |
| 2 | Map Integration | MapController, cluster layers, popup handlers |
| 3 | Time System | TimeController, TimeSlider, WorldClock |
| 4 | Contact Filter | ContactFilter component, search, presets |
| 5 | Date/Time Picker | Calendar, presets, time inputs |
| 6 | Polish & Test | Animations, responsive, cross-browser |

**Total: 6 days** (reduced from original 12 days due to simplified architecture)

---

## Success Criteria

### Functional

- [ ] Map loads full viewport without scrollbars
- [ ] Theme toggle switches map style smoothly
- [ ] Time slider scrubs through data
- [ ] Play/pause animates through timeline
- [ ] Speed controls affect playback rate
- [ ] Contact filter updates map in real-time
- [ ] Date/time picker sets time range
- [ ] Cluster markers show event counts
- [ ] Individual markers show event details
- [ ] World clock displays current data time

### Performance

- [ ] Initial load < 3 seconds
- [ ] 60fps animations
- [ ] Handles 10,000+ events smoothly
- [ ] File size < 500KB (excluding data)

### Design Quality

- [ ] Glassmorphic panels look premium
- [ ] Consistent typography hierarchy
- [ ] Smooth hover/focus states
- [ ] Mobile-responsive (tablet+)
- [ ] WCAG AA color contrast

### Code Quality

- [ ] Clear module comment blocks
- [ ] No console errors
- [ ] Works in Chrome, Firefox, Safari, Edge
- [ ] Single file, zero build dependencies

---

## Appendix: Mapbox Token Configuration

Users must provide their own Mapbox token. The token is injected during HTML generation.

### Getting a Token

1. Create account at [mapbox.com](https://www.mapbox.com/)
2. Navigate to Account > Tokens
3. Create new token with scopes:
   - `styles:read`
   - `fonts:read`
   - `styles:tiles`
4. Copy public token (starts with `pk.`)

### Security Notes

- The token is embedded in the HTML file
- Use URL restrictions in Mapbox dashboard for production
- Never commit tokens to version control
- Consider environment variable injection in CI/CD

---

*This plan provides a complete, implementable specification for a premium CDR visualization tool that addresses all critical gaps while maintaining the stunning visual quality of the original design.*
